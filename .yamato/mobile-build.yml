{% metadata_file .yamato/project.metafile %}
---

{% for project in projects -%}
{% for editor in project.test_editors -%}
Build_Player_With_Tests_iOS_{{ project.name }}_{{ editor }}:
    name: build {{ project.name }} - {{ editor }} on iOS
    agent:
        type: Unity::VM::osx
        image: mobile/macos-10.15-testing:stable
        flavor: b1.large

    commands:
        - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
        - unity-downloader-cli -c Editor -c iOS -u {{ editor }} --fast --wait
        - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr --output utr
        - chmod +x ./utr
        - ./utr --suite=playmode --platform=iOS --editor-location=.Editor --testproject={{ project.path }} --player-save-path=build/players --artifacts_path=build/logs --build-only --testfilter=Unity.Multiplayer.Samples.BossRoom.Tests.Runtime

    artifacts:
        players:
            paths:
                - "build/players/**"
        logs:
            paths:
                - "build/logs/**"
{% endfor -%}
{% endfor -%}

{% for project in projects -%}
{% for editor in project.test_editors -%}
Build_Player_With_Tests_Android_{{ project.name }}_{{ editor }}:
    name: build {{ project.name }} - {{ editor }} on Android
    agent:
        type: Unity::VM
        # Any generic image can be used, no need to have Android tools in the image for building
        # All Android tools will be downloaded by unity-downloader-cli
        image: desktop/android-execution-r19:v0.1.1-860408
        flavor: b1.xlarge

    commands:
        # Download unity-downloader-cli
        - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
        - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools/utr-standalone/utr.bat --output utr.bat
        - python .yamato/disable-burst-if-requested.py --project-path {{ project.path }} --platform Android
        - unity-downloader-cli -c Editor -c Android -u {{ editor }} --fast --wait
        # Build player(s)
        - ./utr.bat --suite=playmode --platform=Android --editor-location=.Editor --testproject={{ project.path }} --player-save-path=build/players --artifacts_path=build/logs --scripting-backend=mono --build-only --testfilter=Unity.Multiplayer.Samples.BossRoom.Tests.Runtime
    artifacts:
        players:
            paths:
                - "build/players/**"
        logs:
            paths:
                - "build/logs/**"
    variables:
        CI: true
        ENABLE_BURST_COMPILATION: False
{% endfor -%}
{% endfor -%}
